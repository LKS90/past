<?php

/**
 * @file
 * Contains tests for the past_db Admin UI.
 */

class PastDBBaseTestCase extends DrupalWebTestCase {

  protected $event_desc;
  protected $machine_name;
  protected $severities;

  protected function createEvents($count = 99) {
    // Set some for log creation.
    $this->machine_name = 'machine name';
    $this->severities = past_event_severities();
    $severities_codes = array_keys($this->severities);
    $this->event_desc = 'message #';

    // Prepare some logs.
    for($i = 0; $i <= $count; $i++) {
      $severity_index = $severities_codes[rand(0, 7)];
      $event = past_event_create('past_db', $this->machine_name, $this->event_desc . ($i + 1));
      $event->addArgument('arg1', 'First Argument');
      $event->addArgument('arg2', new stdClass());
      $event->addArgument('arg3', FALSE);
      $event->setSeverity($severity_index);
      $event->save();
    }
  }

  /**
   * @return PastEvent[]
   */
  protected function loadEvents() {
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'past_event');
    $result = $query->execute();
    return entity_load('past_event', array_keys($result['past_event']));
  }
}

class PastDBTest extends PastDBBaseTestCase {

  static function getInfo() {
    return array(
      'name' => 'Past DB tests',
      'description' => 'Tests for DB backend of the Past module.',
      'group' => 'Past',
    );
  }

  function setUp() {
    parent::setUp(array('views', 'past', 'past_db'));
    $admin = $this->drupalCreateUser(array('administer past'));
    $this->drupalLogin($admin);
    $this->createEvents();
  }

  /**
   * Tests event bundles.
   */
  function testEventBundles() {
    $event_type = past_event_type_create('test_event', 'Test event');
    $event_type->save();

    $event_type = past_event_get_types('test_event');
    $this->assertEqual($event_type->label, 'Test event');
    $this->assertEqual($event_type->type, 'test_event');

    $event = past_event_create('past', 'test_event', 'test message');
    $event->type = 'test_event';
    $event->save();

    $events = $this->loadEvents();
    $event = array_pop($events);

    $wrapper = entity_metadata_wrapper('past_event', $event);
    $this->assertEqual($wrapper->getBundle(), 'test_event');
  }

  /**
   * Tests the pas event log UI.
   */
  public function testAdminUI() {
    // Open the event log.
    $this->drupalGet('admin/reports/past');

    // Check for some messages.
    $this->assertText($this->event_desc . 100);
    $this->assertText($this->event_desc . 99);
    $this->assertText($this->event_desc . 98);
    $this->assertText($this->event_desc . 51);

    // Check severities.
    $this->assertText($this->severities[PAST_SEVERITY_DEBUG]);
    $this->assertText($this->severities[PAST_SEVERITY_INFO]);
    $this->assertText($this->severities[PAST_SEVERITY_WARNING]);

    // Check machine name.
    $this->assertText($this->machine_name);

    // Check for the exposed filter fields.
    $this->assertFieldByName('module', '');
    $this->assertFieldByName('severity[]', '');
    $this->assertFieldByName('message', '');

    // Check paging.
    $this->assertText('next ›');
    $this->assertText('last »');

    // Open the 2nd page.
    $options = array(
      'query' => array(
        'module' => '',
        'message' => '',
        'page' => 1,
      ),
    );
    $this->drupalGet('admin/reports/past', $options);

    // Check for some messages.
    $this->assertText($this->event_desc . 50);
    $this->assertText($this->event_desc . 49);
    $this->assertText($this->event_desc . 1);

    // Check paging.
    $this->assertText('‹ previous');
    $this->assertText('« first');

    // Go to the first detail page
    $this->drupalGet('admin/reports/past/1');

    $this->assertText($this->machine_name);
    $this->assertText($this->event_desc . 1);
    $this->assertText('arg1');
    $this->assertText('arg2');
    $this->assertText('arg3');
    $this->assertText('First Argument');

    $this->drupalLogout();

    // Check permissions for detail page.
    $this->drupalGet('admin/reports/past/1');
    $this->assertText(t('You are not authorized to access this page'));
    // Check permissions for event log.
    $this->drupalGet('admin/reports/past');
    $this->assertText(t('You are not authorized to access this page'));
  }
}
